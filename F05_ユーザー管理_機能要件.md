# F05 ユーザー管理 機能要件

## 1. 目的
- ログイン機能を提供し、マイページやお気に入りなど、ユーザー固有の機能を安全に利用できるようにする。
- 視聴ログやお気に入り情報をユーザー単位で蓄積し、レコメンドや分析に活用できる状態を整える。
- ユーザー名変更などの基本的なプロフィール編集を安全に提供し、自己表現と匿名性の調整を可能にする。

## 2. 対象範囲・前提
- 年齢確認（F01）を通過していることを前提とする。
- 縦スクロール視聴や検索は未ログインでも利用可とし、マイページ・お気に入り機能はログイン必須とする。
- 認証方式は JWT を使用する。

## 3. 機能概要
- ユーザー登録、ログイン、ログアウト、トークン更新などの API を提供する。
- ゲスト利用時は匿名 ID を発行し、視聴ログを紐付ける。
- ログイン後に、可能であれば匿名 ID に紐付く視聴ログとの統合を検討する。
- マイページのプロフィール編集からユーザー名変更フォームを表示し、入力されたユーザー名を更新する。

## 4. 詳細要件
- 認証・認可
  - マイページ、各種お気に入り操作は JWT による認証が必須。
  - トークンはヘッダー経由で送信し、有効期限やリフレッシュ方式は設計段階で定義する。
- ユーザー登録／ログイン
  - 登録 API: 必須項目はメールアドレスとパスワードを最低限とし、メールアドレスでログインする。
  - ログイン API: 認証成功時に JWT を発行し、フロントに返却。
  - ログアウト API: サーバ側でのトークン無効化方式は設計で検討。
- ゲスト利用
  - 匿名 ID をクライアントに付与し、視聴ログや検索ログと紐付ける。
  - ログイン後に匿名 ID とユーザー ID の紐付け／統合を行うかは、設計で詳細を決める。
- ロギング
  - ログイン成功／失敗、登録、ログアウトなどのイベントをログとして保存する。
- ユーザー名変更
  - アクセス制御: ログイン必須。
  - 入力・バリデーション: 最大50文字、NGワードなし。絵文字・記号も許容し、ユーザー名の重複は許容する。
  - 更新処理: 正常に更新できた場合は即時にプロフィール情報と画面表示へ反映する。変更履歴の保持有無は運用要件に応じて検討する。
  - ロギング: 変更イベントをログ化し、変更前後の値は必要最小限で取り扱う。

## 5. 入出力
- 入力: 登録情報、ログイン情報、新しいユーザー名、JWT トークン、ログアウト／トークン更新リクエスト。
- 出力: 認証結果、JWT トークン、ユーザー基本情報（ユーザー名含む）、ステータスコード。

## 6. 関連
- F02 縦スクロール視聴・レコメンド: ログインユーザー向けレコメンドの前提。
- F04 外部サービス遷移: 遷移ログをユーザー単位で分析する際に利用。
- F04 マイページ: ログイン必須機能として連携。
- F06/F10/F11 お気に入り機能: ログイン済みユーザーに対して提供。

