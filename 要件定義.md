# 要件定義書  
R18縦型スクロール動画サービス（アフィリエイト型）

## 1. 目的・背景
本サービスは、スマートフォン利用者に対して縦型スクロールで成人向けサンプル動画を連続視聴させ、各作品詳細ページを外部サービス（DMM等）へ誘導し、アフィリエイト収益を獲得することを目的とする。既存R18動画サービスのUI/UXの陳腐化、短尺・縦型トレンドの顕在化を背景に、軽量な動画視聴プラットフォームとして設計する。

## 2. スコープ

### 2.1 対象
- 動画一覧／縦型スクロール再生
- 年齢確認（Yes/No）
- ユーザー管理（ログインは任意）
- 外部サービス（DMM）への遷移
- 動画メタ情報取得（DMM API）
- 検索（作品／出演者）
- 発売日別動画一覧（今日／今週／来週）
- 視聴ログ収集
- レコメンド（ログイン時トップ）
- **マイページ**
  - お気に入り動画
  - お気に入りジャンル
  - お気に入り女優
  - **ユーザー名変更**

### 2.2 スコープ外
- 決済機能
- 課金履歴管理
- 権利証跡管理
- 制作者向け管理機能

## 3. 全体アーキテクチャ概要（要件レベル）

### 3.1 構成概要
- クライアント：Web（PWA想定）
- APIサーバ：
  - ユーザー管理／JWT認証
  - 動画メタデータ取得（キャッシュ）
  - 検索API
  - 発売日別データ取得
  - 視聴ログ収集
  - レコメンド生成
  - **お気に入りデータ管理（動画／ジャンル／女優）**
  - **ユーザー名変更API**
- 外部API：DMM API
- ストリーミング：DMM提供URLを利用

### 3.2 アーキテクチャ要件
- 動画は保持せず、外部API URLを使用
- 外部APIの負荷を考慮して内部キャッシュを実装
- 視聴ログ保存は必須（UserID もしくは匿名ID）

## 4. 非機能要件

### 4.1 性能
- 動画切替：1〜1.5秒以内
- 同時接続数：初期30程度

### 4.2 可用性
- 稼働時間帯：17:00〜28:00

### 4.3 セキュリティ
- ログイン時のみ JWT 認証
- HTTPS
- 不正アクセスの簡易検知

### 4.4 運用・保守
- 行動ログ（視聴ログ）
- アプリログ／APIエラーログ
- DMM API障害検知

## 5. 画面一覧
- 年齢確認（Yes/No）
- ホーム画面  
  - ログイン：レコメンド  
  - 未ログイン：通常一覧
- 動画詳細画面
- 検索画面／検索結果一覧
- 発売日別動画画面（今日／今週／来週）
- ログイン／新規登録画面
- **マイページ**
  - プロフィール編集（ユーザー名変更）
  - お気に入り動画
  - お気に入りジャンル
  - お気に入り女優

## 6. ユースケース

### UC-01：初回訪問ユーザー
1. サイトアクセス  
2. 年齢確認  
3. 縦スクロール視聴  
4. 外部遷移（必要時）

### UC-02：ログインユーザー（レコメンド起点）
1. ログイン  
2. ホームでレコメンド表示  
3. 縦型視聴  
4. 検索 or 発売日一覧へ遷移  
5. 外部遷移

### UC-03：検索利用（ログイン／未ログイン共通）
1. 検索アイコン  
2. キーワード入力  
3. 検索結果一覧  
4. 動画詳細 → 視聴 → 外部遷移

### UC-04：発売日別動画閲覧
1. 発売日一覧アクセス  
2. 今日／今週／来週  
3. 動画詳細 → 視聴 → 外部遷移

### UC-05：マイページでの操作
1. マイページへ遷移  
2. お気に入り動画／ジャンル／女優を閲覧  
3. 必要に応じてお気に入り解除  
4. プロフィール編集でユーザー名変更

### UC-06：未ログインユーザーのマイページ誘導
1. マイページへアクセス  
2. ログイン画面へ誘導  
3. ログイン後にマイページ表示

## 7. 機能要件一覧
| ID | 機能名 | 概要 | 詳細仕様 |
|----|--------|------|----------|
| F-01 | 年齢確認 | Yes/No 入場判定 | F-01.md |
| F-02 | 縦型スクロール再生 | サンプル動画の連続視聴 | F-02.md |
| F-03 | 動画メタ情報取得 | DMM API | F-03.md |
| F-04 | 外部サービス遷移 | DMM誘導 | F-04.md |
| F-05 | ユーザー管理 | JWTログイン／登録／ユーザー名変更 | F-05.md |
| F-06 | お気に入り（動画） | ログイン時のみ | F-06.md |
| F-07 | 検索 | 作品／出演者検索 | F-07.md |
| F-08 | 発売日別動画表示 | 今日／今週／来週 | F-08.md |
| F-09 | 視聴ログ | ログ収集＋レコメンド基盤 | F-09.md |
| F-10 | レコメンド | 視聴ログから算出 | F-10.md |
| F-11 | **マイページ** | プロフィール編集／お気に入り管理 | F-11.md |
| F-12 | **お気に入り（ジャンル）** | ジャンル別のお気に入り | F-12.md |
| F-13 | **お気に入り（女優）** | 女優別のお気に入り | F-13.md |


## 8. データ要件
- ユーザー情報（ユーザー名含む）
- お気に入り（動画）
- お気に入り（ジャンル）
- お気に入り（女優）
- 動画メタ情報（キャッシュ）
- 視聴ログ（必須）

## 9. 機能詳細要件たたき台
### F-01 年齢確認
- サイト入場前に「18歳以上ですか？」をYes/Noで提示。Yesのみ入場を許可、Noは利用不可メッセージを表示。
- 許可状態はセッション等で保持し、失効時は再確認。直接URLアクセスも年齢確認へリダイレクト。
- 選択結果とタイムスタンプをイベントログとして保存可能（匿名ID）。

### F-02 縦型スクロール再生
- サンプル動画を縦型リストで表示し、視野に入った動画を自動再生/離脱で停止。
- ページ末尾で次ページ有無をチェックし、あればシームレスにロード。無ければ「該当する動画がなくなりました」を表示。
- 各カードにタイトル/出演者/発売日と外部遷移リンクを表示。DMM APIから取得。
- 視聴開始・終了・完了率・終了理由を視聴ログとして送信（ゲストは匿名ID、ログインはユーザーID）。

### F-03 動画メタ情報取得
- DMM APIからタイトル・出演者・発売日・サンプル動画URLを取得し、内部キャッシュを挟んで配信。
- ページネーション情報（次/前ページ有無）を付与し、フロントの縦スクロールに渡す。
- APIエラー時は再試行後、ユーザーに再取得ボタンと失敗メッセージを提示。

### F-04 外部サービス遷移
- 各動画カードに外部サービス（DMM）への遷移リンクを配置し、新規タブ/同タブは設計で決定。
- クリックイベントをログに残し、レコメンドや効果測定に利用。

### F-05 ユーザー管理
- ログインは任意。お気に入り/マイページ利用時にJWTログインが必須。
- 新規登録・ログイン・ログアウトAPIを提供し、トークン更新をサポート。
- ゲストは匿名IDで視聴ログを紐付け、ログイン後に統合する設計も検討。
- **ユーザー名変更**: マイページ等からユーザー名を変更可能とし、即時反映する。

### F-06 お気に入り（動画）
- ログインユーザーのみ利用可。動画カードから追加/解除でき、マイページに即時反映。
- お気に入り一覧は追加日時降順で表示。上限や重複は設計で定義。
- 追加/解除イベントをログ化し、レコメンドに活用可能。

### F-07 検索
- キーワード必須。対象はタイトル/出演者/ジャンル切替可（デフォルト全体）。
- ログイン/未ログインとも利用可。結果は縦スクロールUIで表示し、ページ末尾で次ページ自動取得。
- 検索クエリ・結果件数・エラーを匿名IDまたはユーザーIDと紐付けてログ化。

### F-08 発売日別動画表示
- プリセットで今日/明日/近日（例: 今週/来週）を用意し、1クリックで検索を発行。
- 結果は縦スクロール表示し、ページネーションで自動ロード。尽きたら終了メッセージ。
- メタ情報（タイトル/出演者/発売日）と外部遷移リンクを表示。

### F-09 視聴ログ
- 収集項目: ユーザー識別子（匿名ID/ユーザーID）、動画ID、再生開始/終了時刻、完了率、終了理由（完了/スキップ/スクロールアウト）、ページ番号。
- 送信タイミング: 再生開始時・終了時（中断含む）。通信失敗時はリトライまたはバッファリングを検討。

### F-10 レコメンド
- 視聴ログ・お気に入り情報を元にトップの動画リストを算出。アルゴリズム詳細は設計フェーズで決定。
- 生成できない場合はデフォルトリスト（最新/人気）を返却。

### F-11 マイページ
- ログイン必須。プロフィール表示、ユーザー名編集、お気に入り（動画/ジャンル/女優）一覧を提供。
- お気に入り一覧はタブ/セクションで切替表示。動画一覧は縦スクロールUIを流用可。

### F-12 お気に入り（ジャンル）
- ログイン必須。ジャンル単位で追加/解除、一覧表示。重複登録防止。
- レコメンドへの活用を想定し、操作イベントをログ化。

### F-13 お気に入り（女優）
- ログイン必須。女優単位で追加/解除、一覧表示。重複登録防止。
- 操作イベントをログ化し、レコメンドに利用可能。


